import React, {useState, useContext, useEffect, useRef} from 'react'
import AuthContext from '../../middleware/AuthContext';
import { useNavigate } from 'react-router-dom';
import { CssBaseline } from '@mui/material';
import { Box, Grid, FormControl, InputLabel, Select, MenuItem } from '@mui/material';
import ErrorAlert from '../../components/ErrorAlert';
import axios from 'axios';
import ClientTable from '../../components/ClientTable';
export default function Client() {
    const [formHeight, setFormHeight] = useState(0)
    const formRef = useRef(null)
    const [error, setError] = useState('')
    const [services, setServices] = useState([])
    const [selectedService, setSelectedService] = useState('')
    const [content, setContent] = useState([])
    const navigate = useNavigate()
    const {token} = useContext(AuthContext)
    

    useEffect(() => {
        if(token === null) {
            navigate('/login')
        } else {
            setFormHeight(formRef.current.offsetHeight);
            axios.get('/service_list')
            .then((res)=> {
                setServices(res.data.result)
            })
        }
    }, [token, navigate]);

    const handleServiceChange = (e) => {
        setSelectedService(e.target.value)
        axios.get('/get_service', {params:{service_name:e.target.value}})
        .then((res) => {
            setContent(res.data.result)
        })
        .catch((err) => {
            setError(err)
        })
    }
    return (
        <>
        <CssBaseline />
        <Box sx={{flexGrow: 1, height: `calc(100vh - ${formHeight}px)`, display: 'flex', flexDirection: 'column'}}>
        <Box ref={formRef}>
        <Grid item xs={12}>
            <ErrorAlert message={error}/>
            <h2>顧客情報</h2>
            <FormControl fullWidth>
                <InputLabel>サービス名</InputLabel>
                <Select 
                    label="サービス名"
                    value={selectedService}
                    onChange={handleServiceChange}
                >
                {services.map((service) => (
                    <MenuItem key={service} value={service}>
                        {service}
                    </MenuItem>
                ))}
              </Select>
            </FormControl>
          </Grid>
        </Box>
        <Box mt={2}  sx={{flexGrow: 1, overflow: 'auto'}}>
            <Grid item xs={12} sx={{height: '100%'}}>
                <ClientTable client={content}/>
            </Grid>
        </Box>
        </Box>
        </>
    )
}