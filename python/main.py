from flask import Flask, render_template, request, redirect, g, url_for, current_app, jsonify, send_file
from flask_cors import CORS
import requests
import os, base64, mimetypes
from urllib.parse import unquote
from modules.DBManager import DBManager
from models.employee import EmployeeManager
from faker import Faker


app = Flask(__name__)
CORS(app, origins=["http://react:3000"])

dbm = DBManager()
emm = EmployeeManager()



@app.route('/login', methods=['POST'])
def login():
    data = request.get.json()
    name = data.get('name')
    return jsonify({"hoge": "poop"})

@app.route('/image', methods=["GET"])
def Image():
    path = "images/" + request.args.get('path')

    if os.path.exists(path) and os.path.isfile(path):
        try:
            with open(path, 'rb') as image_file:
                encoded_string = base64.b64encode(image_file.read()).decode('utf-8')
                return jsonify({'image': 'data:image/png;base64,' + encoded_string})
        except Exception as e:
            return jsonify({'message': str(e)}), 500
    else:
        return jsonify({'message': '画像が見つかりませんでした'}), 404

@app.route("/file", methods=["GET"])
def File():
    fileName = unquote(request.args.get('filename'))
    file = os.path.join('./file', fileName)
    if not os.path.isfile(file):
        return {"message": "file not found"}, 404
    return send_file(file)

@app.route('/employee/search', methods=["GET"])
def Employee():
    name = request.args.get('name')
    employee = emm.read_by_name(name)

    return jsonify({"employee": employee})

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8080, debug=True)